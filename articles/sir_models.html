<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SIR models • odin.dust</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="SIR models">
<meta property="og:description" content="odin.dust">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">odin.dust</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.2.18</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/sir_models.html">SIR models</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mrc-ide/odin.dust/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="sir_models_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>SIR models</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mrc-ide/odin.dust/blob/HEAD/vignettes/sir_models.Rmd" class="external-link"><code>vignettes/sir_models.Rmd</code></a></small>
      <div class="hidden name"><code>sir_models.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="stochastic-sir-model-definition">Stochastic SIR model definition<a class="anchor" aria-label="anchor" href="#stochastic-sir-model-definition"></a>
</h2>
<p>A simple definition of the SIR model, as given in the <a href="https://mrc-ide.github.io/odin/articles/discrete.html" class="external-link">odin documentation</a> is: <span class="math display">\[\begin{align*}
\frac{dS}{dt} &amp;= -\beta \frac{SI}{N} \\
\frac{dI}{dt} &amp;= \beta \frac{SI}{N} - \gamma I \\
\frac{dR}{dt} &amp;= \gamma I \\
\end{align*}\]</span> <span class="math inline">\(S\)</span> is the number of susceptibles, <span class="math inline">\(I\)</span> is the number of infected and <span class="math inline">\(R\)</span> is the number recovered; the total population size <span class="math inline">\(N = S + I + R\)</span> is constant. <span class="math inline">\(\beta\)</span> is the infection rate, <span class="math inline">\(\gamma\)</span> is the recovery rate.</p>
<p>Discretising this model in time steps of width <span class="math inline">\(dt\)</span> gives the following update equations for each time step:</p>
<p><span class="math display">\[\begin{align*}
S_{t+1} &amp;= S_t - n_{SI} \\
I_{t+1} &amp;= I_t + n_{SI} - n_{IR} \\
R_{t+1} &amp;= R_t + n_{IR}
\end{align*}\]</span></p>
<p>where <span class="math display">\[\begin{align*}
n_{SI} &amp;\sim B(S, 1 - e^{-\beta \frac{I}{N} \cdot dt}) \\
n_{IR} &amp;\sim B(I, 1 - e^{-\gamma \cdot dt})
\end{align*}\]</span></p>
<div class="section level3">
<h3 id="implementing-the-sir-model-using-odin-dust">Implementing the SIR model using <a href="https://mrc-ide.github.io/odin.dust/" class="external-link"><code>odin.dust</code></a><a class="anchor" aria-label="anchor" href="#implementing-the-sir-model-using-odin-dust"></a>
</h3>
<p>The above equations can straightforwardly be written out using the odin DSL:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Definition of the time-step and output as "time"</span>
<span class="va">dt</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
<span class="fu">initial</span><span class="op">(</span><span class="va">time</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">0</span>
<span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">step</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="va">dt</span>

<span class="co">## Core equations for transitions between compartments:</span>
<span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span><span class="va">S</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">S</span> <span class="op">-</span> <span class="va">n_SI</span>
<span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span><span class="va">I</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">I</span> <span class="op">+</span> <span class="va">n_SI</span> <span class="op">-</span> <span class="va">n_IR</span>
<span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span><span class="va">R</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">R</span> <span class="op">+</span> <span class="va">n_IR</span>

<span class="co">## Individual probabilities of transition:</span>
<span class="va">p_SI</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">beta</span> <span class="op">*</span> <span class="va">I</span> <span class="op">/</span> <span class="va">N</span> <span class="op">*</span> <span class="va">dt</span><span class="op">)</span> <span class="co"># S to I</span>
<span class="va">p_IR</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">gamma</span> <span class="op">*</span> <span class="va">dt</span><span class="op">)</span> <span class="co"># I to R</span>

<span class="co">## Draws from binomial distributions for numbers changing between</span>
<span class="co">## compartments:</span>
<span class="va">n_IR</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">I</span>, <span class="va">p_IR</span><span class="op">)</span>
<span class="va">n_SI</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">S</span>, <span class="va">p_SI</span><span class="op">)</span>

<span class="co">## Total population size</span>
<span class="va">N</span> <span class="op">&lt;-</span> <span class="va">S</span> <span class="op">+</span> <span class="va">I</span> <span class="op">+</span> <span class="va">R</span>

<span class="co">## Initial states:</span>
<span class="fu">initial</span><span class="op">(</span><span class="va">S</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">S_ini</span>
<span class="fu">initial</span><span class="op">(</span><span class="va">I</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">I_ini</span>
<span class="fu">initial</span><span class="op">(</span><span class="va">R</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">0</span>

<span class="co">## User defined parameters - default in parentheses:</span>
<span class="va">S_ini</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span>
<span class="va">I_ini</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>
<span class="va">beta</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="fl">0.2</span><span class="op">)</span>
<span class="va">gamma</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="fl">0.1</span><span class="op">)</span></code></pre></div>
<p>This is converted to a C++ dust model, and compiled into a library in a single step, using <a href="https://mrc-ide.github.io/odin.dust/" class="external-link"><code>odin.dust</code></a>. Save the above code as a file named <code>sir.R</code>. File names must not contain special characters.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mrc-ide/odin.dust" class="external-link">odin.dust</a></span><span class="op">)</span>
<span class="va">gen_sir</span> <span class="op">&lt;-</span> <span class="fu">odin.dust</span><span class="fu">::</span><span class="fu"><a href="../reference/odin_dust.html">odin_dust</a></span><span class="op">(</span><span class="st">"sir.R"</span><span class="op">)</span>
<span class="co">#&gt; Loading required namespace: pkgbuild</span>
<span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> 18 functions decorated with [[cpp11::register]]</span>
<span class="co">#&gt; <span style="color: #00BB00;">✔</span> generated file <span style="color: #0000BB;">cpp11.R</span></span>
<span class="co">#&gt; <span style="color: #00BB00;">✔</span> generated file <span style="color: #0000BB;">cpp11.cpp</span></span>
<span class="co">#&gt; Re-compiling sirb906c7e5</span>
<span class="co">#&gt; * installing *source* package ‘sirb906c7e5’ ...</span>
<span class="co">#&gt; ** using staged installation</span>
<span class="co">#&gt; ** libs</span>
<span class="co">#&gt; clang++ -mmacosx-version-min=10.13 -std=gnu++11 -I"/Library/Frameworks/R.framework/Resources/include" -DNDEBUG  -I'/Users/runner/work/_temp/Library/cpp11/include' -I/usr/local/include  -I/Users/runner/work/_temp/Library/dust/include -DHAVE_INLINE  -fPIC  -Wall -g -O2  -Wall -pedantic -fdiagnostics-color=always -c cpp11.cpp -o cpp11.o</span>
<span class="co">#&gt; clang++ -mmacosx-version-min=10.13 -std=gnu++11 -I"/Library/Frameworks/R.framework/Resources/include" -DNDEBUG  -I'/Users/runner/work/_temp/Library/cpp11/include' -I/usr/local/include  -I/Users/runner/work/_temp/Library/dust/include -DHAVE_INLINE  -fPIC  -Wall -g -O2  -Wall -pedantic -fdiagnostics-color=always -c dust.cpp -o dust.o</span>
<span class="co">#&gt; <span style="font-weight: bold;">dust.cpp:298:28: </span><span style="color: #BB00BB; font-weight: bold;">warning: </span><span style="font-weight: bold;">unused variable 'internal' [-Wunused-variable]</span></span>
<span class="co">#&gt;   const sir::internal_type internal = pars.internal;</span>
<span class="co">#&gt; <span style="color: #00BB00; font-weight: bold;">                           ^</span></span>
<span class="co"><span style="color: #00BB00; font-weight: bold;">#&gt; </span><span style="font-weight: bold;">dust.cpp:57:17: </span><span style="color: #BB00BB; font-weight: bold;">warning: </span><span style="font-weight: bold;">private field 'internal' is not used [-Wunused-private-field]</span></span>
<span class="co">#&gt;   internal_type internal;</span>
<span class="co">#&gt; <span style="color: #00BB00; font-weight: bold;">                ^</span></span>
<span class="co"><span style="color: #00BB00; font-weight: bold;">#&gt; </span>2 warnings generated.</span>
<span class="co">#&gt; clang++ -mmacosx-version-min=10.13 -std=gnu++11 -dynamiclib -Wl,-headerpad_max_install_names -undefined dynamic_lookup -single_module -multiply_defined suppress -L/Library/Frameworks/R.framework/Resources/lib -L/usr/local/lib -o sirb906c7e5.so cpp11.o dust.o -F/Library/Frameworks/R.framework/.. -framework R -Wl,-framework -Wl,CoreFoundation</span>
<span class="co">#&gt; installing to /private/var/folders/24/8k48jl6d249_n_qfxwsl6xvm0000gn/T/Rtmp0y4cY2/devtools_install_7935c1fc711/00LOCK-file79342761a5e/00new/sirb906c7e5/libs</span>
<span class="co">#&gt; ** checking absolute paths in shared objects and dynamic libraries</span>
<span class="co">#&gt; * DONE (sirb906c7e5)</span>
<span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Loading <span style="color: #0000BB;">sirb906c7e5</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="saving-a-model-into-a-package">Saving a model into a package<a class="anchor" aria-label="anchor" href="#saving-a-model-into-a-package"></a>
</h3>
<p>If you want to distribute your model in an R package, rather than building it locally, you will want to use the <code><a href="../reference/odin_dust_package.html">odin_dust_package()</a></code> function instead. This will write the transpiled C++ dust code into <code>src</code> and its R interface in <code>R/dust.R</code>. Package users are not required to regenerate the dust code, and their compiler will build the library when they install the package. You may also wish to add a file <code>R/zzz.R</code> to your package <code>myrpackage</code> with the following lines:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">##' @useDynLib myrpackage, .registration = TRUE</span>
<span class="cn">NULL</span></code></pre></div>
<p>to help automate the compilation of the model.</p>
</div>
</div>
<div class="section level2">
<h2 id="running-the-sir-model-with-dust">Running the SIR model with <a href="https://mrc-ide.github.io/dust/" class="external-link"><code>dust</code></a><a class="anchor" aria-label="anchor" href="#running-the-sir-model-with-dust"></a>
</h2>
<p>Now we can use the <code>new</code> method on the generator to make <code>dust</code> objects. <code>dust</code> can be driven directly from R, and also interfaces with the <a href="https://mrc-ide.github.io/mcstate/" class="external-link"><code>mcstate</code></a> package to allow parameter inference and forecasting.</p>
<p><a href="https://mrc-ide.github.io/dust/reference/dust.html#method-new" class="external-link"><code>new()</code></a> takes the data needed to run the model i.e. a list with any parameters defined as <code>user</code> in the odin code above, the value of the initial step <span class="math inline">\(t_0\)</span>, and the number of particles, each for now can simply be thought of as an independent stochastic realisation of the model, but in the next step will be used when inferring model parameters.</p>
<p>Additional arguments include the number of threads to parallelise the particles over, and the seed for the random number generator. The seed must be an integer, and using the same seed will ensure reproducible results for all particles. To use this to directly create a new dust object with 10 particles, run using 4 threads:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sir_model</span> <span class="op">&lt;-</span> <span class="va">gen_sir</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>dt <span class="op">=</span> <span class="fl">1</span>,
                                     S_ini <span class="op">=</span> <span class="fl">1000</span>,
                                     I_ini <span class="op">=</span> <span class="fl">10</span>,
                                     beta <span class="op">=</span> <span class="fl">0.2</span>,
                                     gamma <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span>,
                         step <span class="op">=</span> <span class="fl">1</span>,
                         n_particles <span class="op">=</span> <span class="fl">10L</span>,
                         n_threads <span class="op">=</span> <span class="fl">4L</span>,
                         seed <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span></code></pre></div>
<p>The initial state is ten particles wide, four states deep (<span class="math inline">\(t\)</span>, <span class="math inline">\(S\)</span>, <span class="math inline">\(I\)</span>, <span class="math inline">\(R\)</span>):</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sir_model</span><span class="op">$</span><span class="fu">state</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt;      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10]</span>
<span class="co">#&gt; [1,]    0    0    0    0    0    0    0    0    0     0</span>
<span class="co">#&gt; [2,] 1000 1000 1000 1000 1000 1000 1000 1000 1000  1000</span>
<span class="co">#&gt; [3,]   10   10   10   10   10   10   10   10   10    10</span>
<span class="co">#&gt; [4,]    0    0    0    0    0    0    0    0    0     0</span></code></pre></div>
<p>Run the particles (repeats) forward 10 steps of length <span class="math inline">\(dt\)</span>, followed by another 10 steps:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sir_model</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>
<span class="co">#&gt;      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10]</span>
<span class="co">#&gt; [1,]   10   10   10   10   10   10   10   10   10    10</span>
<span class="co">#&gt; [2,]  988  974  979  967  972  966  956  975  987   955</span>
<span class="co">#&gt; [3,]   15   27   24   28   29   29   36   19   13    42</span>
<span class="co">#&gt; [4,]    7    9    7   15    9   15   18   16   10    13</span>
<span class="va">sir_model</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="fl">20</span><span class="op">)</span>
<span class="co">#&gt;      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10]</span>
<span class="co">#&gt; [1,]   20   20   20   20   20   20   20   20   20    20</span>
<span class="co">#&gt; [2,]  937  907  898  870  897  881  870  917  933   867</span>
<span class="co">#&gt; [3,]   36   54   69   79   66   74   71   38   41    71</span>
<span class="co">#&gt; [4,]   37   49   43   61   47   55   69   55   36    72</span></code></pre></div>
<p>We can change the parameters, say by increasing the infection rate and the population size, by reinitalising the model with <code>reset()</code>. We will also use a smaller time step to calculate multiple transitions per unit time:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dt</span> <span class="op">&lt;-</span> <span class="fl">0.25</span>
<span class="va">n_particles</span> <span class="op">&lt;-</span> <span class="fl">10L</span>
<span class="va">p_new</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>dt <span class="op">=</span> <span class="va">dt</span>, S_ini <span class="op">=</span> <span class="fl">2000</span>, I_ini <span class="op">=</span> <span class="fl">10</span>, beta <span class="op">=</span> <span class="fl">0.4</span>, gamma <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span>
<span class="va">sir_model</span><span class="op">$</span><span class="fu">update_state</span><span class="op">(</span>pars <span class="op">=</span> <span class="va">p_new</span>, step <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>
<span class="va">sir_model</span><span class="op">$</span><span class="fu">state</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt;      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10]</span>
<span class="co">#&gt; [1,]    0    0    0    0    0    0    0    0    0     0</span>
<span class="co">#&gt; [2,] 2000 2000 2000 2000 2000 2000 2000 2000 2000  2000</span>
<span class="co">#&gt; [3,]   10   10   10   10   10   10   10   10   10    10</span>
<span class="co">#&gt; [4,]    0    0    0    0    0    0    0    0    0     0</span></code></pre></div>
<p>Let’s run this epidemic forward, and plot the trajectories:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">n_steps</span> <span class="op">&lt;-</span> <span class="fl">200</span>
<span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="cn">NA</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">sir_model</span><span class="op">$</span><span class="fu">info</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">len</span>, <span class="va">n_particles</span>, <span class="va">n_steps</span><span class="op">)</span><span class="op">)</span>

<span class="kw">for</span> <span class="op">(</span><span class="va">t</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">n_steps</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">x</span><span class="op">[</span> , , <span class="va">t</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">sir_model</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="va">t</span><span class="op">)</span>
<span class="op">}</span>
<span class="va">time</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="op">]</span>
<span class="va">x</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span>, , <span class="op">]</span>

<span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4.1</span>, <span class="fl">5.1</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span><span class="op">)</span>, las <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
<span class="va">cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>S <span class="op">=</span> <span class="st">"#8c8cd9"</span>, I <span class="op">=</span> <span class="st">"#cc0044"</span>, R <span class="op">=</span> <span class="st">"#999966"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html" class="external-link">matplot</a></span><span class="op">(</span><span class="va">time</span>, <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">1</span>, , <span class="op">]</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"l"</span>,
         xlab <span class="op">=</span> <span class="st">"Time"</span>, ylab <span class="op">=</span> <span class="st">"Number of individuals"</span>,
         col <span class="op">=</span> <span class="va">cols</span><span class="op">[[</span><span class="st">"S"</span><span class="op">]</span><span class="op">]</span>, lty <span class="op">=</span> <span class="fl">1</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html" class="external-link">matlines</a></span><span class="op">(</span><span class="va">time</span>, <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">2</span>, , <span class="op">]</span><span class="op">)</span>, col <span class="op">=</span> <span class="va">cols</span><span class="op">[[</span><span class="st">"I"</span><span class="op">]</span><span class="op">]</span>, lty <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html" class="external-link">matlines</a></span><span class="op">(</span><span class="va">time</span>, <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">3</span>, , <span class="op">]</span><span class="op">)</span>, col <span class="op">=</span> <span class="va">cols</span><span class="op">[[</span><span class="st">"R"</span><span class="op">]</span><span class="op">]</span>, lty <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"left"</span>, lwd <span class="op">=</span> <span class="fl">1</span>, col <span class="op">=</span> <span class="va">cols</span>, legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">cols</span><span class="op">)</span>, bty <span class="op">=</span> <span class="st">"n"</span><span class="op">)</span></code></pre></div>
<p><img src="sir_models_files/figure-html/unnamed-chunk-7-1.png" width="672"></p>
<div class="section level3">
<h3 id="adding-age-structure-to-the-model">Adding age structure to the model<a class="anchor" aria-label="anchor" href="#adding-age-structure-to-the-model"></a>
</h3>
<p>Adding age structure to the model consists of the following steps, which turn variables into arrays:</p>
<ul>
<li>Define the number of age categories as a user parameter <code>N_age</code>.</li>
<li>Add age structure to each compartment, by adding square brackets to the lvalues.</li>
<li>Modify the rvalues to use quantities from the appropriate compartment, by adding an <code>i</code> index to the rvalues. These will automatically be looped over.</li>
<li>Where an age compartment needs to be reduced into a single compartment/variable, use <code>sum</code> (or another array function from <a href="https://mrc-ide.github.io/odin/articles/functions.html" class="external-link uri">https://mrc-ide.github.io/odin/articles/functions.html</a> as appropriate)</li>
<li>Define the dimensions of all arrays, for example by setting <code>dim(S) &lt;- N_age</code>.</li>
</ul>
<p>This would simply give <code>N_age</code> independent processes equivalent to the first model, scaled by the size of the population in each age category. To actually make this useful, you likely want to add some interaction or transitions between the compartments. An example of this would be to add an age-specific contact matrix, demonstrated below, which defines a different force of infection <span class="math inline">\(\lambda\)</span> for each age group. This is calculated by <span class="math display">\[\lambda_i = \frac{\beta}{N} \cdot \sum_{j=1}^{N_{\mathrm{age}}} I_j m_{ij}\]</span> In the odin code:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m</span><span class="op">[</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="op">)</span> <span class="co"># age-structured contact matrix</span>
<span class="va">s_ij</span><span class="op">[</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">m</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span> <span class="op">*</span> <span class="va">I</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>
<span class="va">lambda</span><span class="op">[</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">beta</span> <span class="op">/</span> <span class="va">N</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">s_ij</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span><span class="op">)</span></code></pre></div>
<p>The probability of infection of a susceptible is then indexed by this force of infection:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">p_SI</span><span class="op">[</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">lambda</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">*</span> <span class="va">dt</span><span class="op">)</span></code></pre></div>
<p>Putting this all together, the age structured SIR model is as follows:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Definition of the time-step and output as "time"</span>
<span class="va">dt</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="op">)</span>
<span class="fu">initial</span><span class="op">(</span><span class="va">time</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">0</span>
<span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">step</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="va">dt</span>

<span class="co">## Core equations for transitions between compartments:</span>
<span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span><span class="va">S_tot</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">S_tot</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">n_SI</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span><span class="va">I_tot</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">I_tot</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">n_SI</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">n_IR</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span><span class="va">R_tot</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">R_tot</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">n_IR</span><span class="op">)</span>

<span class="co">## Equations for transitions between compartments by age group</span>
<span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span><span class="va">S</span><span class="op">[</span><span class="op">]</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">S</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="va">n_SI</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span><span class="va">I</span><span class="op">[</span><span class="op">]</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">I</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">+</span> <span class="va">n_SI</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="va">n_IR</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span><span class="va">R</span><span class="op">[</span><span class="op">]</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">R</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">+</span> <span class="va">n_IR</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>

<span class="co">## To compute cumulative incidence</span>
<span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span><span class="va">cumu_inc</span><span class="op">[</span><span class="op">]</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">cumu_inc</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">+</span> <span class="va">n_SI</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>

<span class="co">## Individual probabilities of transition:</span>
<span class="va">p_SI</span><span class="op">[</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">lambda</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">*</span> <span class="va">dt</span><span class="op">)</span> <span class="co"># S to I</span>
<span class="va">p_IR</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">gamma</span> <span class="op">*</span> <span class="va">dt</span><span class="op">)</span> <span class="co"># I to R</span>

<span class="co">## Force of infection</span>
<span class="va">m</span><span class="op">[</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="op">)</span> <span class="co"># age-structured contact matrix</span>
<span class="va">s_ij</span><span class="op">[</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">m</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span> <span class="op">*</span> <span class="va">I</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>
<span class="va">lambda</span><span class="op">[</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">beta</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">s_ij</span><span class="op">[</span>, <span class="va">i</span><span class="op">]</span><span class="op">)</span>

<span class="co">## Draws from binomial distributions for numbers changing between</span>
<span class="co">## compartments:</span>
<span class="va">n_SI</span><span class="op">[</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">S</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">p_SI</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>
<span class="va">n_IR</span><span class="op">[</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">I</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="va">p_IR</span><span class="op">)</span>

<span class="co">## Initial states:</span>
<span class="fu">initial</span><span class="op">(</span><span class="va">S_tot</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">S_ini</span><span class="op">)</span>
<span class="fu">initial</span><span class="op">(</span><span class="va">I_tot</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">I_ini</span><span class="op">)</span>
<span class="fu">initial</span><span class="op">(</span><span class="va">R_tot</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">0</span>

<span class="fu">initial</span><span class="op">(</span><span class="va">S</span><span class="op">[</span><span class="op">]</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">S_ini</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>
<span class="fu">initial</span><span class="op">(</span><span class="va">I</span><span class="op">[</span><span class="op">]</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">I_ini</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>
<span class="fu">initial</span><span class="op">(</span><span class="va">R</span><span class="op">[</span><span class="op">]</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">0</span>
<span class="fu">initial</span><span class="op">(</span><span class="va">cumu_inc</span><span class="op">[</span><span class="op">]</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">0</span>

<span class="co">## User defined parameters - default in parentheses:</span>
<span class="va">S_ini</span><span class="op">[</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="op">)</span>
<span class="va">I_ini</span><span class="op">[</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="op">)</span>
<span class="va">beta</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="fl">0.0165</span><span class="op">)</span>
<span class="va">gamma</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="fl">0.1</span><span class="op">)</span>

<span class="co"># dimensions of arrays</span>
<span class="va">N_age</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">S_ini</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">N_age</span>
<span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">I_ini</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">N_age</span>
<span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">S</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">N_age</span>
<span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">I</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">N_age</span>
<span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">R</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">N_age</span>
<span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">cumu_inc</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">N_age</span>
<span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">n_SI</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">N_age</span>
<span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">n_IR</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">N_age</span>
<span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">p_SI</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">N_age</span>
<span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">N_age</span>, <span class="va">N_age</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">s_ij</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">N_age</span>, <span class="va">N_age</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">lambda</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">N_age</span></code></pre></div>
<p>As before, save the file, and use <code>odin.dust</code> to compile the model:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">gen_age</span> <span class="op">&lt;-</span> <span class="fu">odin.dust</span><span class="fu">::</span><span class="fu"><a href="../reference/odin_dust.html">odin_dust</a></span><span class="op">(</span><span class="st">"sirage.R"</span><span class="op">)</span>
<span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> 18 functions decorated with [[cpp11::register]]</span>
<span class="co">#&gt; <span style="color: #00BB00;">✔</span> generated file <span style="color: #0000BB;">cpp11.R</span></span>
<span class="co">#&gt; <span style="color: #00BB00;">✔</span> generated file <span style="color: #0000BB;">cpp11.cpp</span></span>
<span class="co">#&gt; Re-compiling siraged3f65e02</span>
<span class="co">#&gt; * installing *source* package ‘siraged3f65e02’ ...</span>
<span class="co">#&gt; ** using staged installation</span>
<span class="co">#&gt; ** libs</span>
<span class="co">#&gt; clang++ -mmacosx-version-min=10.13 -std=gnu++11 -I"/Library/Frameworks/R.framework/Resources/include" -DNDEBUG  -I'/Users/runner/work/_temp/Library/cpp11/include' -I/usr/local/include  -I/Users/runner/work/_temp/Library/dust/include -DHAVE_INLINE  -fPIC  -Wall -g -O2  -Wall -pedantic -fdiagnostics-color=always -c cpp11.cpp -o cpp11.o</span>
<span class="co">#&gt; clang++ -mmacosx-version-min=10.13 -std=gnu++11 -I"/Library/Frameworks/R.framework/Resources/include" -DNDEBUG  -I'/Users/runner/work/_temp/Library/cpp11/include' -I/usr/local/include  -I/Users/runner/work/_temp/Library/dust/include -DHAVE_INLINE  -fPIC  -Wall -g -O2  -Wall -pedantic -fdiagnostics-color=always -c dust.cpp -o dust.o</span>
<span class="co">#&gt; clang++ -mmacosx-version-min=10.13 -std=gnu++11 -dynamiclib -Wl,-headerpad_max_install_names -undefined dynamic_lookup -single_module -multiply_defined suppress -L/Library/Frameworks/R.framework/Resources/lib -L/usr/local/lib -o siraged3f65e02.so cpp11.o dust.o -F/Library/Frameworks/R.framework/.. -framework R -Wl,-framework -Wl,CoreFoundation</span>
<span class="co">#&gt; installing to /private/var/folders/24/8k48jl6d249_n_qfxwsl6xvm0000gn/T/Rtmp0y4cY2/devtools_install_7937404536a/00LOCK-file79362807f97/00new/siraged3f65e02/libs</span>
<span class="co">#&gt; ** checking absolute paths in shared objects and dynamic libraries</span>
<span class="co">#&gt; * DONE (siraged3f65e02)</span>
<span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Loading <span style="color: #0000BB;">siraged3f65e02</span></span></code></pre></div>
<p>We can generate an age-structured contact matrix based on the <a href="https://journals.plos.org/plosmedicine/article?id=10.1371/journal.pmed.0050074" class="external-link">POLYMOD</a> survey by using the <a href="https://github.com/sbfnk/socialmixr" class="external-link">socialmixr</a> package:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">polymod</span>, package <span class="op">=</span> <span class="st">"socialmixr"</span><span class="op">)</span>

<span class="co">## In this example we use 8 age bands of 10 years from 0-70 years old.</span>
<span class="va">age.limits</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">70</span>, <span class="fl">10</span><span class="op">)</span>

<span class="co">## Get the contact matrix from socialmixr</span>
<span class="va">contact</span> <span class="op">&lt;-</span> <span class="fu">socialmixr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/socialmixr/man/contact_matrix.html" class="external-link">contact_matrix</a></span><span class="op">(</span>
  survey <span class="op">=</span> <span class="va">polymod</span>,
  countries <span class="op">=</span> <span class="st">"United Kingdom"</span>,
  age.limits <span class="op">=</span> <span class="va">age.limits</span>,
  symmetric <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="co">#&gt; Using POLYMOD social contact data. To cite this in a publication, use the 'cite' function</span>
<span class="co">#&gt; Removing participants that have contacts without age information. To change this behaviour, set the 'missing.contact.age' option</span>

<span class="co">## Transform the matrix to the (symetrical) transmission matrix</span>
<span class="co">## rather than the contact matrix. This transmission matrix is</span>
<span class="co">## weighted by the population in each age band.</span>
<span class="va">transmission</span> <span class="op">&lt;-</span> <span class="va">contact</span><span class="op">$</span><span class="va">matrix</span> <span class="op">/</span>
  <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">contact</span><span class="op">$</span><span class="va">demography</span><span class="op">$</span><span class="va">population</span>, each <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">contact</span><span class="op">$</span><span class="va">matrix</span><span class="op">)</span><span class="op">)</span>
<span class="va">transmission</span>
<span class="co">#&gt;       contact.age.group</span>
<span class="co">#&gt;              [0,10)      [10,20)      [20,30)      [30,40)      [40,50)</span>
<span class="co">#&gt;   [1,] 7.351697e-07 1.681349e-07 1.623038e-07 2.523168e-07 1.257326e-07</span>
<span class="co">#&gt;   [2,] 1.681349e-07 1.036281e-06 1.692542e-07 1.697777e-07 2.181730e-07</span>
<span class="co">#&gt;   [3,] 1.623038e-07 1.692542e-07 4.704750e-07 2.056299e-07 2.070420e-07</span>
<span class="co">#&gt;   [4,] 2.523168e-07 1.697777e-07 2.056299e-07 3.117035e-07 2.231807e-07</span>
<span class="co">#&gt;   [5,] 1.257326e-07 2.181730e-07 2.070420e-07 2.231807e-07 3.354107e-07</span>
<span class="co">#&gt;   [6,] 8.037308e-08 1.039198e-07 1.799980e-07 1.678511e-07 1.757299e-07</span>
<span class="co">#&gt;   [7,] 8.154532e-08 6.991192e-08 1.165298e-07 1.498801e-07 1.457821e-07</span>
<span class="co">#&gt;   [8,] 2.994231e-08 7.542364e-08 5.972715e-08 4.640225e-08 1.250247e-07</span>
<span class="co">#&gt;       contact.age.group</span>
<span class="co">#&gt;             [50,60)      [60,70)          70+</span>
<span class="co">#&gt;   [1,] 8.037308e-08 8.154532e-08 2.994231e-08</span>
<span class="co">#&gt;   [2,] 1.039198e-07 6.991192e-08 7.542364e-08</span>
<span class="co">#&gt;   [3,] 1.799980e-07 1.165298e-07 5.972715e-08</span>
<span class="co">#&gt;   [4,] 1.678511e-07 1.498801e-07 4.640225e-08</span>
<span class="co">#&gt;   [5,] 1.757299e-07 1.457821e-07 1.250247e-07</span>
<span class="co">#&gt;   [6,] 2.473517e-07 1.652266e-07 1.076856e-07</span>
<span class="co">#&gt;   [7,] 1.652266e-07 2.010654e-07 1.431130e-07</span>
<span class="co">#&gt;   [8,] 1.076856e-07 1.431130e-07 1.941792e-07</span></code></pre></div>
<p>This can be given as a parameter to the model by adding the argument <code>pars = list(m = transmission)</code> when using the <code>new()</code> method on the <code>gen_age</code> generator.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">N_age</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">age.limits</span><span class="op">)</span>
<span class="va">n_particles</span> <span class="op">&lt;-</span> <span class="fl">5L</span>
<span class="va">dt</span> <span class="op">&lt;-</span> <span class="fl">0.25</span>
<span class="va">model</span> <span class="op">&lt;-</span> <span class="va">gen_age</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>dt <span class="op">=</span> <span class="va">dt</span>,
                                 S_ini <span class="op">=</span> <span class="va">contact</span><span class="op">$</span><span class="va">demography</span><span class="op">$</span><span class="va">population</span>,
                                 I_ini <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>,
                                 beta <span class="op">=</span> <span class="fl">0.2</span> <span class="op">/</span> <span class="fl">12.11</span>,
                                 gamma <span class="op">=</span> <span class="fl">0.1</span>,
                                 m <span class="op">=</span> <span class="va">transmission</span>,
                                 N_age <span class="op">=</span> <span class="va">N_age</span><span class="op">)</span>,
                     step <span class="op">=</span> <span class="fl">1</span>,
                     n_particles <span class="op">=</span> <span class="va">n_particles</span>,
                     n_threads <span class="op">=</span> <span class="fl">1L</span>,
                     seed <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span>

<span class="co"># Define how long the model runs for, number of steps</span>
<span class="va">n_steps</span> <span class="op">&lt;-</span> <span class="fl">1000</span>

<span class="co"># Create an array to contain outputs after looping the model.</span>
<span class="co"># Array contains 35 rows = Total S, I, R (3), and</span>
<span class="co"># in each age compartment (24) as well as the cumulative incidence (8)</span>
<span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="cn">NA</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">model</span><span class="op">$</span><span class="fu">info</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">len</span>, <span class="va">n_particles</span>, <span class="va">n_steps</span><span class="op">)</span><span class="op">)</span>

<span class="co"># For loop to run the model iteratively</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">t</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">n_steps</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">x</span><span class="op">[</span> , , <span class="va">t</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">model</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="va">t</span><span class="op">)</span>
<span class="op">}</span>
<span class="va">time</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="op">]</span>
<span class="va">x</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span>, , <span class="op">]</span>
<span class="co"># Plotting the trajectories</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">4</span><span class="op">)</span>, oma<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">3</span>,<span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">N_age</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">4</span>, <span class="fl">2</span>, <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span>
  <span class="va">cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>S <span class="op">=</span> <span class="st">"#8c8cd9"</span>, I <span class="op">=</span> <span class="st">"#cc0044"</span>, R <span class="op">=</span> <span class="st">"#999966"</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html" class="external-link">matplot</a></span><span class="op">(</span><span class="va">time</span>, <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="va">i</span> <span class="op">+</span> <span class="fl">3</span>,, <span class="op">]</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"l"</span>, <span class="co"># Offset to access numbers in age compartment</span>
          xlab <span class="op">=</span> <span class="st">""</span>, ylab <span class="op">=</span> <span class="st">""</span>, yaxt<span class="op">=</span><span class="st">"none"</span>, main <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Age "</span>, <span class="va">contact</span><span class="op">$</span><span class="va">demography</span><span class="op">$</span><span class="va">age.group</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>,
          col <span class="op">=</span> <span class="va">cols</span><span class="op">[[</span><span class="st">"S"</span><span class="op">]</span><span class="op">]</span>, lty <span class="op">=</span> <span class="fl">1</span>, ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">:</span><span class="op">-</span><span class="fl">3</span>,,<span class="op">]</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html" class="external-link">matlines</a></span><span class="op">(</span><span class="va">time</span>, <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="va">i</span> <span class="op">+</span> <span class="fl">3</span> <span class="op">+</span> <span class="va">N_age</span>, , <span class="op">]</span><span class="op">)</span>, col <span class="op">=</span> <span class="va">cols</span><span class="op">[[</span><span class="st">"I"</span><span class="op">]</span><span class="op">]</span>, lty <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html" class="external-link">matlines</a></span><span class="op">(</span><span class="va">time</span>, <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="va">i</span> <span class="op">+</span> <span class="fl">3</span> <span class="op">+</span> <span class="fl">2</span><span class="op">*</span><span class="va">N_age</span>, , <span class="op">]</span><span class="op">)</span>, col <span class="op">=</span> <span class="va">cols</span><span class="op">[[</span><span class="st">"R"</span><span class="op">]</span><span class="op">]</span>, lty <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"right"</span>, lwd <span class="op">=</span> <span class="fl">1</span>, col <span class="op">=</span> <span class="va">cols</span>, legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">cols</span><span class="op">)</span>, bty <span class="op">=</span> <span class="st">"n"</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/axis.html" class="external-link">axis</a></span><span class="op">(</span><span class="fl">2</span>, las <span class="op">=</span><span class="fl">2</span><span class="op">)</span>
<span class="op">}</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/mtext.html" class="external-link">mtext</a></span><span class="op">(</span><span class="st">"Number of individuals"</span>, side<span class="op">=</span><span class="fl">2</span>,line<span class="op">=</span><span class="fl">1</span>, outer<span class="op">=</span><span class="cn">T</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/mtext.html" class="external-link">mtext</a></span><span class="op">(</span><span class="st">"Time"</span>, side <span class="op">=</span> <span class="fl">1</span>, line <span class="op">=</span> <span class="fl">0</span>, outer <span class="op">=</span><span class="cn">T</span><span class="op">)</span></code></pre></div>
<p><img src="sir_models_files/figure-html/unnamed-chunk-10-1.png" width="672"></p>
<p>Note that a scale factor is introduced for beta so that <span class="math inline">\(R_0\)</span> remains at 2, offsetting the scaling of the contact matrix <code>m</code>. This is calculated using the next-generation matrix. See <a href="https://doi.org/10.1016/j.idm.2017.06.002" class="external-link">Driessche</a> and <a href="https://dx.doi.org/10.1016/j.mbs.2012.07.007" class="external-link">Towers and Feng</a>.</p>
<p>Many other methods are available on the dust object to support inference, but typically you may want to use the <a href="https://mrc-ide.github.io/mcstate/" class="external-link"><code>mcstate</code></a> package instead of calling these directly. However, if you wish to simulate state space models with set parameters, this can be done entirely using the commands above from <a href="https://mrc-ide.github.io/dust/" class="external-link"><code>dust</code></a>.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Rich FitzJohn, John Lees.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.4.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
